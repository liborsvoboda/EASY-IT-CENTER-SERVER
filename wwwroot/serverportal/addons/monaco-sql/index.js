require.config({ paths: { 'vs': './vs' }})
require(['vs/editor/editor.main'], function() {
  const SORT_TEXT = {
    Table: '0',
    Column: '1',
    Keyword: '2'
  }
  let db_keywords = [
    'SELECT',
    'FROM',
    'WHERE',
    'GROUP BY',
    'ORDER BY',
    'ASC',
    'DESC'
  ]
  let db_schema = window.db_schema = {
      tables: ["BasicViewAttachmentList", "ProdGuidWorkList", "ProdGuidOperationList", "LicSrvUsedLicenseList", "BusinessMaturityList", "ProdGuidPartList", "ProdGuidPersonList", "SystemGroupMenuList", "ServerHealthCheckTaskList", "LicSrvLicenseActivationFailList", "ProdGuidGroupList", "BusinessNotesList", "ServerToolTypeList", "PortalApiTableColumnDataList", "WebGroupMenuList", "SystemIgnoredExceptionList", "BusinessOfferSupportList", "SolutionMottoList", "BusinessIncomingOrderList", "BusinessAddressList", "ServerModuleAndServiceList", "BusinessCreditNoteSupportList", "SystemModuleList", "BusinessIncomingInvoiceList", "UserImageGalleryList", "SystemMenuList", "SystemReportList", "BusinessPaymentStatusList", "TemplateList", "SolutionEmailTemplateList", "SolutionUserList", "SolutionEmailerHistoryList", "BasicCurrencyList", "WebBannedIpAddressList", "BusinessIncomingInvoiceSupportList", "BusinessPaymentMethodList", "BasicCalendarList", "SystemCustomPageList", "SystemLoginHistoryList", "ServerStaticOrMvcDefPathList", "WebCoreFileList", "BusinessOutgoingOrderList", "SystemTranslationList", "SystemReportQueueList", "WebDeveloperNewsList", "SolutionMessageTypeList", "UserAccessKeyList", "SystemSvgIconList", "ServerStartUpScriptList", "BusinessWarehouseList", "SolutionCodeLibraryList", "SolutionMessageModuleList", "WebDocumentationList", "BusinessReceiptList", "BusinessOutgoingInvoiceSupportList", "SolutionLanguageList", "WebGlobalPageBlockList", "BasicViewAttachmentList", "BasicAttachmentList", "SolutionFailList", "BasicVatList", "MigrationsHistoryList", "WebMenuList", "SolutionOperationList", "DocSrvDocumentationList", "WebSettingList", "ServerParameterList", "SolutionMixedEnumList", "BusinessOutgoingOrderSupportList", "ServerLiveDataMonitorList", "BusinessOutgoingInvoiceList", "WebVisitIpList", "DocSrvDocumentationGroupList", "BasicUnitList", "BusinessIncomingOrderSupportList", "BasicImageGalleryList", "SolutionSchedulerList", "UserParameterList", "SolutionSchedulerProcessList", "DocSrvDocTemplateList", "BasicItemList", "SolutionTaskList", "PortalApiTableList", "BusinessReceiptSupportList", "BusinessExchangeRateList", "LicSrvLicenseAlgorithmList", "SolutionUserRoleList", "SystemDocumentAdviceList", "BusinessCreditNoteList", "ServerToolPanelDefinitionList", "BusinessBranchList", "ServerCorsDefAllowedOriginList", "WebUserSettingList", "BusinessOfferList", "ServerApiSecurityList"
      ],
      table_columns: {
          BasicViewAttachmentList: [
              { name: "ReadRestrictedAccess", type: "bit" },
              { name: "WriteRestrictedAccess", type: "bit" },
              { name: "ReadAllowedRoles", type: "varchar" },
              { name: "WriteAllowedRoles", type: "varchar" },
              { name: "InheritedApiType", type: "varchar" },
              { name: "OfferValidity", type: "int" },
              { name: "AllowedDomain", type: "varchar" },
              { name: "Command", type: "varchar" },
              { name: "InheritedToolLinkType", type: "varchar" },
              { name: "ToolTypeId", type: "int" },
              { name: "EndDate", type: "date" },
              { name: "StartDate", type: "date" },
              { name: "Prefix", type: "varchar" },
              { name: "InheritedDocumentType", type: "varchar" },
              { name: "BranchId", type: "int" },
              { name: "UsedCount", type: "int" },
              { name: "ActivationLimit", type: "int" },
              { name: "LimitActive", type: "bit" },
              { name: "Algorithm", type: "varchar" },
              { name: "ValidTo", type: "date" },
              { name: "ValidFrom", type: "date" },
              { name: "InheritedTableType", type: "varchar" },
              { name: "Documentation", type: "varchar" },
              { name: "InheritedStatusType", type: "varchar" },
              { name: "InheritedTargetType", type: "varchar" },
              { name: "CurrencyId", type: "int" },
              { name: "VatId", type: "int" },
              { name: "Template", type: "varchar" },
              { name: "ProcessCompleted", type: "bit" },
              { name: "ProcessCrashed", type: "bit" },
              { name: "ProcessLog", type: "varchar" },
              { name: "ProcessData", type: "varchar" },
              { name: "ScheduledTaskId", type: "int" },
              { name: "InheritedIntervalType", type: "varchar" },
              { name: "Interval", type: "int" },
              { name: "FinishAt", type: "datetime2" },
              { name: "StartAt", type: "datetime2" },
              { name: "StartNowOnly", type: "bit" },
              { name: "Data", type: "varchar" },
              { name: "InheritedGroupName", type: "varchar" },
              { name: "WhoIsInformations", type: "varchar" },
              { name: "WebHostIp", type: "varchar" },
              { name: "CreditNoteId", type: "int" },
              { name: "ReceiptId", type: "int" },
              { name: "FileExtensions", type: "varchar" },
              { name: "RootPath", type: "varchar" },
              { name: "ItemsGroup", type: "varchar" },
              { name: "HelpUrl", type: "varchar" },
              { name: "InheritedServerParamType", type: "varchar" },
              { name: "Key", type: "nvarchar" },
              { name: "DocumentationGroupId", type: "int" },
              { name: "InheritedApiResultType", type: "varchar" },
              { name: "InputData", type: "varchar" },
              { name: "InheritedOperationType", type: "varchar" },
              { name: "UserIPAddress", type: "varchar" },
              { name: "AdminMenu", type: "bit" },
              { name: "UserMenu", type: "bit" },
              { name: "MenuClass", type: "varchar" },
              { name: "ProductVersion", type: "nvarchar" },
              { name: "MigrationId", type: "nvarchar" },
              { name: "AttachmentName", type: "varchar" },
              { name: "ImageName", type: "varchar" },
              { name: "Message", type: "varchar" },
              { name: "LogLevel", type: "varchar" },
              { name: "InheritedLogMonitorType", type: "varchar" },
              { name: "Attachment", type: "varbinary" },
              { name: "InheritedParentRecordType", type: "varchar" },
              { name: "ParentId", type: "int" },
              { name: "ProviderHtmlContent", type: "varchar" },
              { name: "AdminHtmlContent", type: "varchar" },
              { name: "UserHtmlContent", type: "varchar" },
              { name: "GuestHtmlContent", type: "varchar" },
              { name: "InheritedPagePartType", type: "varchar" },
              { name: "InvoiceNumber", type: "varchar" },
              { name: "AutoVersion", type: "int" },
              { name: "HtmlContent", type: "varchar" },
              { name: "MdContent", type: "varchar" },
              { name: "ToUserId", type: "int" },
              { name: "FromUserId", type: "int" },
              { name: "Published", type: "bit" },
              { name: "IsSystemMessage", type: "bit" },
              { name: "Archived", type: "bit" },
              { name: "Shown", type: "bit" },
              { name: "HtmlMessage", type: "varchar" },
              { name: "MessageTypeId", type: "int" },
              { name: "MessageParentId", type: "int" },
              { name: "Level", type: "int" },
              { name: "CodeContent", type: "varchar" },
              { name: "InheritedCodeType", type: "varchar" },
              { name: "LastStockTaking", type: "datetime2" },
              { name: "LockedByStockTaking", type: "bit" },
              { name: "AllowNegativeStatus", type: "bit" },
              { name: "Installed", type: "bit" },
              { name: "Pid", type: "int" },
              { name: "RunOnServerStartUp", type: "bit" },
              { name: "StartCommand", type: "varchar" },
              { name: "InstallCommand", type: "varchar" },
              { name: "WorkingDirectory", type: "varchar" },
              { name: "InheritedProcessType", type: "varchar" },
              { name: "InheritedOsType", type: "varchar" },
              { name: "SvgIconPath", type: "varchar" },
              { name: "ApiKey", type: "varchar" },
              { name: "AppClientSecret", type: "varchar" },
              { name: "AppClientId", type: "varchar" },
              { name: "RegisteredAppId", type: "varchar" },
              { name: "InheritedClientType", type: "varchar" },
              { name: "IsSystemOnly", type: "bit" },
              { name: "AnswerAllowed", type: "bit" },
              { name: "RecIdFilterIgnore", type: "bit" },
              { name: "RecId", type: "int" },
              { name: "SearchFilterIgnore", type: "bit" },
              { name: "SearchColumnList", type: "nvarchar" },
              { name: "Search", type: "varchar" },
              { name: "Filter", type: "nvarchar" },
              { name: "TableName", type: "varchar" },
              { name: "Sql", type: "nvarchar" },
              { name: "Backup", type: "varchar" },
              { name: "DescriptionEn", type: "varchar" },
              { name: "DescriptionCz", type: "varchar" },
              { name: "AutoUpdateOnSave", type: "bit" },
              { name: "IsUniquePath", type: "bit" },
              { name: "ProviderContent", type: "varchar" },
              { name: "AdminFileContent", type: "varchar" },
              { name: "UserFileContent", type: "varchar" },
              { name: "GuestFileContent", type: "varchar" },
              { name: "RewriteLowerLevel", type: "bit" },
              { name: "MetroPath", type: "varchar" },
              { name: "InheritedJsCssDefinitionType", type: "varchar" },
              { name: "IsStaticOrMvcDefOnly", type: "bit" },
              { name: "IsBrowsable", type: "bit" },
              { name: "AliasPath", type: "varchar" },
              { name: "WebRootSubPath", type: "varchar" },
              { name: "StartupSubFolder", type: "varchar" },
              { name: "GetWebDataJScriptCmd", type: "varchar" },
              { name: "SetWebDataJScriptCmd", type: "varchar" },
              { name: "DOMHtmlElementName", type: "varchar" },
              { name: "UseIOOverDom", type: "bit" },
              { name: "ColumnName", type: "varchar" },
              { name: "DBTableName", type: "varchar" },
              { name: "HelpTabUrl", type: "varchar" },
              { name: "StartupUrl", type: "varchar" },
              { name: "InheritedSystemApiCallType", type: "varchar" },
              { name: "HelpTabShowOnly", type: "bit" },
              { name: "ShowHelpTab", type: "bit" }, 
              { name: "DevModeEnabled", type: "bit" },
              { name: "IsOwnServerUrl", type: "bit" },
              { name: "IsServerUrl", type: "bit" },
              { name: "IsSystemUrl", type: "bit" },
              { name: "IsInteractAgenda", type: "bit" },
              { name: "InheritedFormType", type: "varchar" },
              { name: "Notes", type: "varchar" },
              { name: "AllowGenerateReceipt", type: "bit" },
              { name: "AutoGenerateReceipt", type: "bit" },
              { name: "Fixed", type: "bit" },
              { name: "ExchangeRate", type: "numeric" },
              { name: "Status", type: "varchar" },
              { name: "Recipient", type: "varchar" },
              { name: "PhoneConfirmed", type: "bit" },
              { name: "EmailConfirmed", type: "bit" },
              { name: "PhotoMimeType", type: "varchar" },
              { name: "Photo", type: "varbinary" },
              { name: "Expiration", type: "datetime2" },
              { name: "AccessToken", type: "varchar" },
              { name: "Password", type: "varchar" },
              { name: "UserName", type: "varchar" },
              { name: "RoleId", type: "int" },
              { name: "Subject", type: "varchar" },
              { name: "Variables", type: "varchar" },
              { name: "TemplateName", type: "varchar" },
              { name: "SystemLanguageId", type: "int" },
              { name: "CreditNote", type: "bit" },
              { name: "Receipt", type: "bit" },
              { name: "File", type: "varbinary" },
              { name: "MimeType", type: "varchar" },
              { name: "ReportPath", type: "varchar" },
              { name: "JoinedId", type: "bit" },
              { name: "PageName", type: "varchar" },
              { name: "NotShowInMenu", type: "bit" },
              { name: "OrderBy", type: "varchar" },
              { name: "AccessUser", type: "varchar" },
              { name: "AccessRole", type: "varchar" },
              { name: "FormPageName", type: "varchar" },
              { name: "InheritedSystemMenuType", type: "varchar" },
              { name: "Price", type: "numeric" },
              { name: "Title", type: "varchar" },
              { name: "Image", type: "varbinary" },
              { name: "IsPrimary", type: "bit" },
              { name: "PaymentStatusId", type: "int" },
              { name: "OrderNumber", type: "varchar" },
              { name: "MaturityId", type: "int" },
              { name: "PaymentMethodId", type: "int" },
              { name: "MaturityDate", type: "datetime2" },
              { name: "TaxDate", type: "datetime2" },
              { name: "IssueDate", type: "datetime2" },
              { name: "IconColor", type: "varchar" },
              { name: "IconName", type: "varchar" },
              { name: "BackgroundColor", type: "varchar" },
              { name: "ForegroundColor", type: "varchar" },
              { name: "StartupCommand", type: "varchar" },
              { name: "InheritedModuleType", type: "varchar" },
              { name: "RedirectSetAllowed", type: "bit" },
              { name: "HtmlSetAllowed", type: "bit" },
              { name: "RestrictionSetAllowed", type: "bit" },
              { name: "PathSetAllowed", type: "bit" },
              { name: "IsLoginModule", type: "bit" },
              { name: "CustomHtmlContent", type: "varchar" },
              { name: "RedirectPathOnError", type: "varchar" },
              { name: "RestrictedAccess", type: "bit" },
              { name: "AllowedRoles", type: "varchar" },
              { name: "OptionalConfiguration", type: "varchar" },
              { name: "UrlSubPath", type: "varchar" },
              { name: "InheritedLayoutType", type: "varchar" },
              { name: "InheritedPageType", type: "varchar" },
              { name: "Dic", type: "varchar" },
              { name: "Ico", type: "varchar" },
              { name: "BankAccount", type: "varchar" },
              { name: "Email", type: "varchar" },
              { name: "Phone", type: "varchar" },
              { name: "PostCode", type: "varchar" },
              { name: "City", type: "varchar" },
              { name: "Street", type: "varchar" },
              { name: "ContactName", type: "varchar" },
              { name: "CompanyName", type: "varchar" },
              { name: "AddressType", type: "varchar" },
              { name: "CustomerOrderNumber", type: "varchar" },
              { name: "TotalCurrencyId", type: "int" },
              { name: "Storned", type: "bit" },
              { name: "Customer", type: "varchar" },
              { name: "Supplier", type: "varchar" },
              { name: "Link", type: "varchar" },
              { name: "TotalPriceWithVat", type: "numeric" },
              { name: "Vat", type: "numeric" },
              { name: "TotalPrice", type: "numeric" },
              { name: "Count", type: "numeric" },
              { name: "PcsPrice", type: "numeric" },
              { name: "Unit", type: "varchar" },
              { name: "DocumentNumber", type: "varchar" },
              { name: "ErrorNumber", type: "varchar" },
              { name: "Onclick", type: "varchar" },
              { name: "InheritedDataType", type: "varchar" },
              { name: "RecGuid", type: "varchar" },
              { name: "ApiTableColumnName", type: "varchar" },
              { name: "ApiTableName", type: "varchar" },
              { name: "Public", type: "bit" },
              { name: "Readme", type: "varchar" },
              { name: "Sequence", type: "int" },
              { name: "UserPrefix", type: "nvarchar" },
              { name: "Port", type: "int" },
              { name: "SizeMB", type: "int" },
              { name: "UrlPath", type: "varchar" },
              { name: "ServerUrlPath", type: "varchar" },
              { name: "DbSqlConnection", type: "varchar" },
              { name: "FolderPath", type: "varchar" },
              { name: "ServerDrive", type: "varchar" },
              { name: "InheritedCheckType", type: "varchar" },
              { name: "TaskName", type: "varchar" },
              { name: "SystemName", type: "varchar" },
              { name: "SurName", type: "varchar" },
              { name: "GroupId", type: "int" },
              { name: "Number", type: "varchar" },
              { name: "Active", type: "bit" },
              { name: "Description", type: "varchar" },
              { name: "Default", type: "bit" },
              { name: "Value", type: "int" },
              { name: "Name", type: "varchar" },
              { name: "IpAddress", type: "varchar" },
              { name: "License", type: "varchar" },
              { name: "ItemId", type: "int" },
              { name: "AddressId", type: "int" },
              { name: "UnlockCode", type: "varchar" },
              { name: "AlgorithmName", type: "varchar" },
              { name: "KcPerKs", type: "numeric" },
              { name: "PcsPerHour", type: "int" },
              { name: "Note", type: "varchar" },
              { name: "UserId", type: "int" },
              { name: "WorkPower", type: "numeric" },
              { name: "Amount", type: "numeric" },
              { name: "Pcs", type: "int" },
              { name: "WorkTime", type: "time" },
              { name: "OperationNumber", type: "int" },
              { name: "WorkPlace", type: "int" },
              { name: "PersonalNumber", type: "int" },
              { name: "Date", type: "datetime2" },
              { name: "TimeStamp", type: "datetime2" },
              { name: "PartNumber", type: "varchar" },
              { name: "FileName", type: "varchar" },
              { name: "Id", type: "int" }]
      }
  }


  window.editor = monaco.editor.create(document.getElementById('container'), {
    value: 'SELECT * FROM ServerParameterList;',
    language: 'sql',
    fontSize: 14,
    minimap: {
      enabled: false
    },
    suggestOnTriggerCharacters: true
  });
  monaco.languages.registerCompletionItemProvider('sql', {
    triggerCharacters: [' ', '.'],
    provideCompletionItems(model, position) {
      const {lineNumber, column} = position
      const textBeforePointer = model.getValueInRange({
        startLineNumber: lineNumber,
        startColumn: 0,
        endLineNumber: lineNumber,
        endColumn: column
      })
      const tokens = textBeforePointer.trim().split(/\s+/)
      const lastToken = tokens[tokens.length - 1].toLowerCase()
      if (lastToken === 'from') {
        return {
          suggestions: db_schema.tables.map(renderTable)
        }
      } else if (lastToken === 'select') {
        return {
          suggestions: getAllTableColumnCompletionItems()
        }
      }
      return {
        suggestions: db_schema.tables.map(renderTable)
          .concat(getAllTableColumnCompletionItems())
          .concat(db_keywords.map(renderKeyword))
      }
    }
  })

  function getAllTableColumnCompletionItems() {
    const table_columns = []
    Object.keys(db_schema.table_columns).forEach(table => {
      db_schema.table_columns[table].forEach(column => {
        table_columns.push(renderTableColumn(table, column))
      })
    })
    return table_columns
  }

  function renderKeyword(keyword) {
    return {
      label: keyword,
      kind: monaco.languages.CompletionItemKind.Keyword,
      detail: '',
      sortText: SORT_TEXT.Keyword,
      insertText: keyword
    }
  }

  function renderTable(name) {
    return {
      label: name,
      kind: monaco.languages.CompletionItemKind.Module,
      detail: '<table>',
      sortText: SORT_TEXT.Table,
      insertText: name
    }
  }

  function renderTableColumn(table, column) {
    return {
      label: column.name,
      kind: monaco.languages.CompletionItemKind.Field,
      detail: '<column> ' + column.type + ' ' + table,
      sortText: SORT_TEXT.Column,
      insertText: column.name
    }
  }
});